from os.path import join, exists, basename
from jinja2 import Environment, FileSystemLoader
from os import makedirs


root_dir = '/home/kimb/factorbook_motif_pipeline/frontend'
user_dir = join( root_dir, 'user_data' )
if not exists( user_dir ) :
        makedirs( user_dir )

user_data_fn = 'user_info.txt'
jobserver="zlab2"
queuefile="/home/kimb/jobqueue" #job queue file in the remote jobserver!
job_dir="/home/kimb/factorbook_motif_pipeline/user_data"

jinja2_template_dir= join( root_dir, 'templates' )
env = Environment(loader=FileSystemLoader( jinja2_template_dir ))

cmd_template="/home/kimb/factorbook_motif_pipeline/bin/start_search.py %s/%%(jobid)s bib:%s" % (job_dir,user_dir)

hostroot = 'http://bib.umassmed.edu'
hostparent = '/factorbook/'
hostaddress= hostroot + hostparent
servername='Factorbook Motif Pipeline'
reference='''<p class=reference>Kim BH, Zhuang J, Wang J, Weng Z. Factorbook motif pipeline 2014 <i>(manuscript in preparation)</i><br>
Wang J, Zhuang J, Iyer S, Lin XY, Greven MC, Kim BH, Moore J, Pierce BG, Dong X, Virgil D, Birney E, Hung JH, Weng Z. Factorbook.org: a Wiki-based database for transcription factor-binding data generated by the ENCODE consortium. <i>Nucleic Acids Res.</i> 2013 Jan;41(Database issue):D171-6</p>'''

admin_email='bonghyun.kim@umassmed.edu'
exampleid='fmp8aL9zl'
logo_rc_fn = 'logo_rc.summary'
max_motif_id = 5

def read_user_info( jobid ) :
        fn = join( user_dir, jobid, user_data_fn )
        fp = open( fn )

        d = {}
        for l in fp :
                i, j = l.split(":")
                d[i] = j.strip()
        return d

filter_cutoffs = { 'T1':0.00001, 'T2':0.1, 'T2/C2':1.25 }

def read_logo_rc_file( jobid ) :
	fn = join( user_dir, jobid, logo_rc_fn )
	fp = open( fn )

	for l in fp :
		l = l.split()
		if l :
			if l[0] == jobid :
				return [ x.replace('eps','png') for x in l[1:] ]
	else :
		raise Exception( 'Logo file does not have Jobid ' + jobid )

motif_logo_dir = 'top500.center.meme_out'
matched_motif_logo_dir = 'top500.center.meme_tomtom_out'
tomtom_result_fn = join( matched_motif_logo_dir, 'tomtom.xml' )

#the # of lines to be used for the pipeline
#if the value is 0 then use all lines.
#use_top_lines = 0 
use_top_lines = 2500
